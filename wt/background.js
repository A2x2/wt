let start;
let time = 0;
let ticks = 0;

// pain.
const WINDOW_INFO = [
    /***************************************** 1 *****************************************/
    {
        time: 0,

        timings:  [
            500,  533,  400,  267,  267,  133,  267,  267,  533,  400,  267,  267,  133,  133,  133,  267,  
            533,  400,  267,  267,  133,  267,  267,  533,  400,  267,  267,  133,  133,  133,  133,  67,  67,
   ...loop([267,  133,  133,  267,  133,  267,  133,  133,  133,  267,  267,
            267,  133,  133,  267,  133,  267,  167,  133,  133,  133,  133,  267,
            267,  133,  133,  267,  133,  267,  133,  133,  133,  267,  267,
            267,  133,  133,  267,  133,  267,  133,  133,  133,  133,  133,  133,   67,   67], 4),
           8676,
   ...loop([267,  133,  133,  267,  133,  267,  133,  133,  133,  267,  267,
            267,  133,  133,  267,  133,  267,  167,  133,  133,  133,  133,  267,
            267,  133,  133,  267,  133,  267,  133,  133,  133,  267,  267,
            267,  133,  133,  267,  133,  267,  133,  133,  133,  133,  133,  133,   67,   67], 4),
           2135,
           8442,
            133,  8508,
            133,  8508,
            133,  8275, 133,
   ...loop([267,  133,  133,  267,  133,  267,  133,  133,  133,  267,  267,
            267,  133,  133,  267,  133,  267,  167,  133,  133,  133,  133,  267,
            267,  133,  133,  267,  133,  267,  133,  133,  133,  267,  267,
            267,  133,  133,  267,  133,  267,  133,  133,  133,  133,  133,  133,   67,   67], 4),
              5
        ],

        sequence: [
              0,    1,    2,    1,    0,    1,    0,    4,    0,    1,    2,    1,    0,    1,    4,    3, 
              1,    2,    1,    0,    1,    0,    4,    0,    1,    2,    1,    0,    1,    4,    3,    4,   3,
     ...loop([1,    3,    4,    1,    4,    0,    1,    4,    1,    0,    3,
              1,    3,    4,    1,    4,    0,    1,    4,    1,    0,    3,    4,
              1,    3,    4,    1,    4,    0,    1,    4,    1,    0,    3,
              1,    3,    4,    1,    4,    0,    1,    4,    1,    0,    3,    4,    3,    4], 4),
              0,
     ...loop([1,    3,    4,    1,    4,    0,    1,    4,    1,    0,    3,
              1,    3,    4,    1,    4,    0,    1,    4,    1,    0,    3,    4,
              1,    3,    4,    1,    4,    0,    1,    4,    1,    0,    3,
              1,    3,    4,    1,    4,    0,    1,    4,    1,    0,    3,    4,    3,    4], 4),
              0,
              2,
              0, 2,
              0, 2,
              0, 2, 0,
     ...loop([1,    3,    4,    1,    4,    0,    1,    4,    1,    0,    3,
              1,    3,    4,    1,    4,    0,    1,    4,    1,    0,    3,    4,
              1,    3,    4,    1,    4,    0,    1,    4,    1,    0,    3,
              1,    3,    4,    1,    4,    0,    1,    4,    1,    0,    3,    4,    3,    4], 4),
              4
        ],

        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    },
    /***************************************** 2 *****************************************/
    {
        time: 0,

        timings:  [ 
            500,
   ...loop([133,  267,  133,  133,  400,  133,  267,  133,  533], 16),
           8776,
   ...loop([133,  267,  133,  133,  400,  133,  267,  133,  533], 16),
           2302,
   ...loop([133,  267,  133,  133,  400,  133,  267,  133,  533], 40),
              5
        ],
        sequence: [
              0,
     ...loop([4,    3,    0,    1,    2,    4,    3,    0,    1], 16),
              0,
     ...loop([4,    3,    0,    1,    2,    4,    3,    0,    1], 16),
              0,
     ...loop([4,    3,    0,    1,    2,    4,    3,    0,    1], 40),
              4
        ],
        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    },
    /***************************************** 3 *****************************************/
    {
        time: 0,

        timings:  [ 
            500,
   ...loop([133,  133,  267,  267,  267,  133,  267,  267,  400,
            133,  133,  267,  267,  267,  133,  267,  267,  133,  267], 16),
            19586,
   ...loop([133,  133,  267,  267,  267,  133,  267,  267,  400,
            133,  133,  267,  267,  267,  133,  267,  267,  133,  267], 16),
              5
        ],
        sequence: [
              0,
     ...loop([1,    0,    1,    0,    3,    1,    0,    1,    4,
              1,    0,    1,    0,    3,    1,    0,    1,    4,    2], 16),
              0,
     ...loop([1,    0,    1,    0,    3,    1,    0,    1,    4,
              1,    0,    1,    0,    3,    1,    0,    1,    4,    2], 16),
              4
        ],
        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    },
    /***************************************** 4 *****************************************/
    {
        time: 0,

        timings:  [ 
            500,
   ...loop([400,  400, 1333,  400,  400, 1367], 14),
            400,  400, 1333,  400,  400,
            20554,            
   ...loop([400,  400, 1333,  400,  400, 1367], 14),
              5
        ],
        sequence: [
              0,
     ...loop([1,    3,    1,    0,    2,    4], 14),
              1,    3,    1,    0,    2,
              0,
     ...loop([1,    3,    1,    0,    2,    4], 14),
              4
        ],
        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    },
    /***************************************** 5 *****************************************/
    {
        time: 0,

        timings:  [ 
            500, 2000,
   ...loop([133, 1733,  267,  133, 2033,  133, 1200,  267,  267,  267,  133, 2000], 6),
            133, 1733,  267,  133, 2033,  133, 1200,  267,  267,  267,
          19320,
   ...loop([133, 1733,  267,  133, 2033,  133, 1200,  267,  267,  267,  133, 2000], 8),
              5
        ],
        sequence: [
              0,    2,
     ...loop([0,    4,    2,    1,    3,    0,    4,    2,    1,    3,    0,    4], 6),
              0,    4,    2,    1,    3,    0,    4,    2,    1,    3,
              0,
     ...loop([0,    4,    2,    1,    3,    0,    4,    2,    1,    3,    0,    4], 8),
              4
        ],
        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    },
    /***************************************** 6 *****************************************/
    {
        time: 0,

        timings:  [ 
            500,
   ...loop([267,  433,  267,  133,  133,  133,  267,  400,  267,  133,  267,  267,  133,  133,  133,  267,  133,  500], 13),
          19620,
   ...loop([267,  433,  267,  133,  133,  133,  267,  400,  267,  133,  267,  267,  133,  133,  133,  267,  133,  500], 13),
              5
        ],
        sequence: [
              0,
     ...loop([1,    4,    2,    0,    3,    1,    2,    4,    0,    3,    1,    2,    4,    0,    1,    3,    2,    4], 13),
              0,
     ...loop([1,    4,    2,    0,    3,    1,    2,    4,    0,    3,    1,    2,    4,    0,    1,    3,    2,    4], 13),
              4
        ],
        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    },
    /***************************************** 7 *****************************************/
    {
        time: 0,

        timings:  [ 
            500,  400,
   ...loop([ 67,   67,  200,   67,   67,  200,  300,   67,   67,  367,   67,   67,  133,  400,
             67,   67,  200,   67,   67,  200,  300,   67,   67,  367,   67,   67,   67,  100,  367,
             67,   67,  200,   67,   67,  233,  300,   67,   67,  367,   67,   67,  133,  400,
             67,   67,  200,   67,   67,  200,  300,   67,   67,  367,  133,  133,  400], 6),
          18886,  400,
   ...loop([ 67,   67,  200,   67,   67,  200,  300,   67,   67,  367,   67,   67,  133,  400,
             67,   67,  200,   67,   67,  200,  300,   67,   67,  367,   67,   67,   67,  100,  367,
             67,   67,  200,   67,   67,  233,  300,   67,   67,  367,   67,   67,  133,  400,
             67,   67,  200,   67,   67,  200,  300,   67,   67,  367,  133,  133,  400], 6),
              5
        ],
        sequence: [
              0,    1,
     ...loop([4,    3,    4,    2,    3,    2,    0,    2,    3,    2,    4,    3,    4,    1,
              4,    3,    4,    2,    3,    2,    0,    2,    3,    2,    3,    4,    3,    4,     1,
              4,    3,    4,    2,    3,    2,    0,    2,    3,    2,    4,    3,    4,    1,
              4,    3,    4,    2,    3,    2,    0,    2,    3,    2,    1,    0,    1], 6),
              0,    1,
     ...loop([4,    3,    4,    2,    3,    2,    0,    2,    3,    2,    4,    3,    4,    1,
              4,    3,    4,    2,    3,    2,    0,    2,    3,    2,    3,    4,    3,    4,     1,
              4,    3,    4,    2,    3,    2,    0,    2,    3,    2,    4,    3,    4,    1,
              4,    3,    4,    2,    3,    2,    0,    2,    3,    2,    1,    0,    1], 6),
              4
        ],
        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    },
    /***************************************** 8 *****************************************/
    {
        time: 0,

        timings:  [ 
            500, 
   ...loop([267,  400,  400,  267,  400,  400,  267,  400,  133,  133,  267,  267,  267,  400], 11),
          19520, 
   ...loop([267,  400,  400,  267,  400,  400,  267,  400,  133,  133,  267,  267,  267,  400], 11),
              5
        ],
        sequence: [
              0,
     ...loop([4,    3,    2,    1,    0,    4,    3,    2,    1,    2,    0,    3,    2,    1], 11),
              0,
     ...loop([4,    3,    2,    1,    0,    4,    3,    2,    1,    2,    0,    3,    2,    1], 11),
              4
        ],
        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    },
    /***************************************** 9 *****************************************/
    {
        time: 0,

        timings:  [ 
            500,
            133,  133,  133,  267,  133,  133,  133,  133,  133,  133,  133,  267,  267,
   ...loop([133,  133,  133,  267,  133,  133,  133,  133,  133,  133,  133,  267,  267,
            133,  133,  133,  267,  133,  133,  133,  133,  133,  133,  167,  267,  133,  133,
            133,  133,  133,  267,  133,  133,  133,  133,  133,  133,  133,  267,  267,
            133,  133,  133,  267,  133,  133,  133,  133,  133,  133,  167,  133,  133,  133,  133], 4),
          34202,
            133,  133,  133,  267,  133,  133,  133,  133,  133,  133,  167,  133,  133,  133,  133,
   ...loop([133,  133,  133,  267,  133,  133,  133,  133,  133,  133,  133,  267,  267,
            133,  133,  133,  267,  133,  133,  133,  133,  133,  133,  167,  267,  133,  133,
            133,  133,  133,  267,  133,  133,  133,  133,  133,  133,  133,  267,  267,
            133,  133,  133,  267,  133,  133,  133,  133,  133,  133,  167,  133,  133,  133,  133], 4),
              5
        ],
        sequence: [
              0,
              2,    0,    1,    4,    1,    4,    3,    0,    1,    2,    3,    0,    1,
     ...loop([2,    0,    1,    4,    1,    4,    3,    0,    1,    2,    3,    0,    1,
              2,    0,    1,    4,    1,    4,    3,    0,    1,    2,    3,    0,    1,    0,
              2,    0,    1,    4,    1,    4,    3,    0,    1,    2,    3,    0,    1,
              2,    0,    1,    4,    1,    4,    3,    0,    1,    2,    3,    0,    1,    0,    1], 4),
              0,
              2,    0,    1,    4,    1,    4,    3,    0,    1,    2,    3,    0,    1,    0,    1,
     ...loop([2,    0,    1,    4,    1,    4,    3,    0,    1,    2,    3,    0,    1,
              2,    0,    1,    4,    1,    4,    3,    0,    1,    2,    3,    0,    1,    0,
              2,    0,    1,    4,    1,    4,    3,    0,    1,    2,    3,    0,    1,
              2,    0,    1,    4,    1,    4,    3,    0,    1,    2,    3,    0,    1,    0,    1], 4),
              4
        ],
        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    },
    /***************************************** 10 *****************************************/
    {
        time: 0,

        timings:  [ 
            500,
   ...loop([ ...Array(40).fill(67), 5873], 4),
            ...Array(40).fill(67),
            33934,
   ...loop([ ...Array(40).fill(67), 5873], 4),
              5
        ],
        sequence: [
              0,
     ...loop([1, 0, 1, 0, 1, 0, 1, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 4], 4),
              1, 0, 1, 0, 1, 0, 1, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2,
              0,
     ...loop([1, 0, 1, 0, 1, 0, 1, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 3, 4, 0, 1, 2, 4], 4),
              4
        ],
        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    },
    /***************************************** 11 *****************************************/
    {
        time: 0,

        timings:  [ 
            500,
            400,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  267,  434,  400,  400,  400,  533,
            400,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  267,  400,  400,  400,  400,  567,
            400,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  267,  400,  400,  400,  400,  533,
            400,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,
          36537,
   ...loop([400,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  267,  434,  400,  400,  400,  533,
            400,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  267,  400,  400,  400,  400,  567,
            400,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  267,  400,  400,  400,  400,  533,
            400,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133,  133], 2),
              5
        ],
        sequence: [
              0,
              1,    3,    0,    3,    4,    2,    1,    0,    3,    1,    3,    1,    0,    4,    3,    2,    1,    0,
              1,    3,    0,    3,    4,    2,    1,    0,    3,    1,    3,    1,    0,    4,    3,    2,    1,    0,
              1,    3,    0,    3,    4,    2,    1,    0,    3,    1,    3,    1,    0,    4,    3,    2,    1,    0,
              1,    3,    0,    3,    4,    2,    1,    0,    3,    1,    3,    1,    3,    0,    1,    2,    3,    4,    2,    0,    1,    3,    2,    4,    0,    3,    1,    2,    4,    2,
              0,
     ...loop([1,    3,    0,    3,    4,    2,    1,    0,    3,    1,    3,    1,    0,    4,    3,    2,    1,    0,
              1,    3,    0,    3,    4,    2,    1,    0,    3,    1,    3,    1,    0,    4,    3,    2,    1,    0,
              1,    3,    0,    3,    4,    2,    1,    0,    3,    1,    3,    1,    0,    4,    3,    2,    1,    0,
              1,    3,    0,    3,    4,    2,    1,    0,    3,    1,    3,    1,    3,    0,    1,    2,    3,    4,    2,    0,    1,    3,    2,    4,    0,    3,    1,    2,    4,    2], 2),
              4
        ],
        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    },
    /***************************************** 12 *****************************************/
    {
        time: 0,

        timings:  [ 
            500,
  ...loop([2236, 2102, 3270,  934, 2236, 2102, 3270, 1000], 10),
            100
        ],
        sequence: [
              0,
  ...loop([   1,    2,    3,    4,    0,    1,    2,    3], 10),              
              0
        ],
        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    },
    /***************************************** 13 *****************************************/
    {
        time: 0,

        timings:  [ 
            500,
             67,  67,  67,  67,  67,  67, 167, 133, 133, 133, 133, 133, 133, 133, 133, 133,  67,  
             67,  67,  67, 133, 133, 267, 133, 133, 133, 133, 133, 133,  67,  67,  67,  67, 133,
            100, 100, 100, 167, 100, 100, 267,  67,  67,  67,  67,  67,  67,  67,  67,  67,  67,
            133, 133, 133, 167,  67,  67,  67,  67,  67,  67, 133, 133, 133, 133, 133, 133, 133,
            133, 133, 133, 133, 133, 133, 133,  67,  67,  67,  67, 133, 133, 133, 133,
             67,  67,  67,  67,  67,  67, 133,  67,  67,  67,  67, 133, 133, 133,  67,  67, 133, 
            133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133, 133,  67,  67,  67,  67, 
             67,  67, 133, 133, 133, 133, 133,  67,  67,  67, 133,  67,  67,  67,  67, 133,  67,  
             67,  67,  67, 100, 133, 133,  67,  67,  67,  67, 133, 133, 100, 133, 100, 100, 100,
            100,  67,  67, 133, 133, 133, 133, 133, 133, 100,  67,  67,  67,  67,  67,  67,  67, 
             67,  67,  67,  67,  67,  67
        ], 
        sequence: [
              0,
              1,   0,   1,   0,   1,   0,   1,   2,   3,   2,   4,   3,   2,   4,   3,   2,   1,
              0,   1,   0,   4,   3,   2,   0,   1,   2,   0,   1,   2,   4,   3,   4,   3,   1,   
              4,   1,   3,   0,   2,   3,   2,   0,   1,   0,   1,   0,   1,   4,   3,   4,   3,   
              2,   4,   3,   2,   0,   1,   0,   1,   0,   1,   3,   2,   1,   4,   2,   0,   1,   
              3,   4,   2,   3,   4,   3,   4,   2,   0,   1,   0,   2,   3,   3,   3,
              1,   0,   1,   0,   1,   0,   2,   4,   3,   4,   3,   0,   1,   3,   0,   1,   4,   
              3,   2,   3,   0,   4,   1,   2,   3,   0,   2,   3,   1,   2,   0,   3,   0,   3,   
              0,   3,   4,   0,   1,   0,   1,   2,   3,   2,   3,   4,   2,   3,   2,   3,   4,   
              2,   3,   2,   3,   4,   2,   1,   0,   1,   0,   3,   4,   2,   4,   0,   3,   2,   
              1,   3,   2,   3,   4,   0,   4,   1,   2,   4,   2,   3,   0,   1,   3,   1,   3,   
              1,   3,   1,   3,   1,   3
        ],
        frame: 0,
        start: -1,
        id: -1,
        tid: -1
    }
];

let windowDelays = [8867, 8433, 5233, 3200, 4566, 4000, 4567, 10433, 1568, 17651, 19286, 51018];
let mainStart = -1;
let mainTime = 0;
const offsX = 19, offsY = 33;

function loop(arr, times) {
    let r = [];
    for (let i = 0; i < times; i++) r = [...r, ...arr];
    return r;
}

function init() {
    mainStart = new Date().getTime();
    openWindow(0);
}

function openWindow(index) {
    const c = browser.windows.create({
        url: [`http://localhost/wt/w.php?n=${index + 1}`, ...Array(4).fill(`http://localhost/wt/w.php?n=${index + 1}&unselected=true`)],
        width: 900,
        height: 300,
        top: 200 + (index * offsY),
        left: 1920 + 200 + (index * offsX)
    });
    c.then(function(w) {
        WINDOW_INFO[index].start = new Date().getTime();
        WINDOW_INFO[index].id = w.id;
        WINDOW_INFO[index].tid = w.tabs[0].id;
        tickSequence(index);
    }, onError);

    const mdelay = windowDelays[index];
    const mdiff = (new Date().getTime() - mainStart) - mainTime;
    mainTime += mdelay;
    if (index < windowDelays.length) setTimeout(function() {
        openWindow(index + 1);
    }, mdelay - mdiff);
}

function onError(error) {
    console.log(`Error: ${error}`);
}

function tickSequence(index) {
    const win = WINDOW_INFO[index];
    const whichTabToFocus = win.sequence[win.frame];
    const delay = win.timings[win.frame];

    browser.tabs.move(win.tid, {
        index: whichTabToFocus
    });

    const diff = (new Date().getTime() - win.start) - WINDOW_INFO[index].time;
    WINDOW_INFO[index].frame++;
    WINDOW_INFO[index].time += delay;

    if (WINDOW_INFO[index].frame < win.sequence.length - 1) setTimeout(function() {
        tickSequence(index);
    }, delay - diff);
}

browser.browserAction.onClicked.addListener(init);